- [一、概述](#一概述)
  - [网络的网络](#网络的网络)
  - [互联网的组成](#互联网的组成)
  - [ISP](#ISP)
  - [主机之间的通信方式](#主机之间的通信方式)
  - [电路交换与分组交换](#电路交换与分组交换)
  - [计算机网络的类别](#计算机网络的类别)
  - [计算机网络的性能](#计算机网络的性能)
  - [计算机网络体系结构](#计算机网络体系结构)
- [二、物理层](#二物理层)
  - [物理层任务](#物理层任务)
  - [通信方式](#通信方式)
  - [信道复用技术](#信道复用技术)
- [三、数据链路层](#三数据链路层)
  - [信道分类](#信道分类)
  - [三个基本问题](#三个基本问题)
  - [PPP 协议](#PPP协议)
  - [局域网](#局域网)
  - [适配器](#适配器)
  - [CSMA/CD 协议](#CSMA/CD协议)
  - [以太网的 MAC 层](#以太网的MAC层)
  - [扩展的以太网](#扩展的以太网)
  - [虚拟局域网](#虚拟局域网)
- [四、网络层](#四网络层)
  - [概述](#概述)
  - [网际协议 IP](#网际协议IP)
  - [分类的 IP 地址](#分类的IP地址)
- [参考资料](#参考资料)

# 一、概述

## 网络的网络

计算机网络由若干 `结点` 和连接这些结点的 `链路` 组成。网络中的结点可以是计算机、集线器、交换机或路由器等。

网络把主机连接起来，而互联网是把多种不同的网络连接起来，因此互联网是网络的网络。

<img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-1.png' width=500>

## 互联网的组成

互联网可以划分为两大块: `边缘部分` 和 `核心部分`

#### 边缘部分

就是连接在互联网上的所有的主机，这些主机又称为 `端系统`，小的端系统可以是一台普通个人电脑和具有上网功能的智能手机，大的端系统是一台非常昂贵的大型计算机。_边缘部分利用核心部分所提供的服务，使众多主机之间能够互相通信并交换或共享信息_

明确一个概念 —— 主机 A 和主机 B 进行通信。

实际上是指: 运行在主机 A 上的某个程序和运行在主机 B 上的某个程序进行通信。由于“进程”就是“运行着的程序”，因此可以理解为: “主机 A 上的某个进程和主机 B 上的另一个进程进行通信”。

#### 核心部分

在核心部分起到特殊作用的是 `路由器`, 它是一种专用计算机。 路由器是实现 `分组交换` 的关键构件，其任务是 `转发收到的分组`

## ISP

互联网服务提供商 ISP 可以从互联网管理机构申请到许多 IP 地址，同时拥有通信线路 (大 ISP 自己建造通信线路，小 ISP 则向电信公司租用通信线路)以及路由器等连网设备，因此任何机构或个人只要向某个 ISP 缴纳规定的费用，就能从该 ISP 获取所需 IP 地址的使用权，并通过该 ISP 接入到互联网。

现在的互联网已经不再是单个组织所拥有而是全世界无数大大小小的 ISP 共同拥有的，这也就是为什么互联网也称为 "网络的网络" 的原因

## 主机之间的通信方式

- 客户服务器方式 ( C/S 方式 ) : 客户是服务请求方，服务器是服务提供方

<img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-2.png' width=420>

- 对等连接方式 (P2P 方式) : 两台主机在通信时不区分哪一个是服务器请求方哪一个是服务器提供方

<img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-3.png' width=420>

## 电路交换与分组交换

### 1. 电路交换

从通信资源分配角度来看，`交换`就是按照某种方式动态地分配传输线路的资源。电路交换用于电话通信系统，两个用户要通信之前需要建立一条`专用的物理链路`，并且在整个通信过程中始终占用该链路。由于通信的过程中不可能一直在使用传输线路，因此电路交换对线路的利用率很低，往往不到 10%。

电路交换的三个步骤 : “ 建立连接 ” -> “ 通话 ” -> “ 释放连接 ”，电路交换的一个重要特点就是: **在通话的全部时间内，通话的两个用户始终占用端到端的通信资源**

<img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-4.png' width=600>

### 2.分组交换

分组交换采用的是<strong>“存储转发”</strong>技术，下图中表示将一个报文划分为几个分组在进行传送。通常我们把要发送的整块数据称为一个 **报文**，在发送报文之前，先把较长的报文划分成一个个更小的等长数据段。在每一个数据段前面，加上一些必要的控制信息组成的<strong>首部</strong>， 就构成了一个分组。

分组又称为<strong>“包”</strong>，首部称为包头。每个分组都有首部和尾部，包含了源地址和目的地址等控制信息，在同一个传输线路上同时传输多个分组互相不会影响，因此在同一条传输线路上允许同时传输多个分组，也就是说分组交换不需要占用传输线路。

<img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-5.png' width=600>

位于网络边缘的主机和位于网络核心部分的路由器都是计算机，但是他们的作用却不一样。_主机是为用户进行信息处理的，可以和其他主机通过网络交换信息，路由器是用来转发分组的，即进行分组交换的。_

路由器收到一个分组，先暂时存储一下，然后检查其首部，也就是包头，查找转发表，按照首部中的目的地址，找到合适的接口转发走出去，把分组交给下一个路由器，这样一步一步的以存储转发的方式，把分组交付给最终的目的主机。

> 路由器暂时存储的是一个个短分组，而不是整个长报文。短分组是暂时存放在路由器的存储器(内存)中而不是存储在磁盘中。这就保证了较高的交换速率。

采用存储转发的分组交换，实质上是采用了在数据通信的过程中断续分配传输带宽的策略，提高通信线路的利用率。

为了提高分组交换网的可靠性，互联网的核心部分常采用<strong>网状拓扑结构</strong>，使得发送网络拥塞或者少数结点、链路出现鼓掌时，路由器可灵活转变转发路由，而不避免引起通信的中断。

## 计算机网络的类别

### 1. 按照网络的作用范围进行分类

- 广域网 WAN

- 城域网 MAN

- 局域网 LAN

- 个人区域网 PAN

### 2. 按照网络的使用者进行分类

- 公用网(public network)

- 专用网(private network)

## 计算机网络的性能

### 速率

网络中的速率指的是`数据的传送速率`，它又称为数据率或比特率。速率的单位是: bit/s。(K=2<sup>10</sup>=1024，M=2<sup>20</sup>，G=2<sup>30</sup>，T=2<sup>40</sup>， ..... )，当提到网络的速率时，往往指的是额定速率或标称速率，而并非网络实际上运行的速率。

### 带宽

带宽本来是指某个信号具有的频带宽度，这种意义的带宽单位是赫。因此，表示某通信道允许通过的信号频带范围就称为该信道的带宽

在计算机网络中，带宽用来表示某通道传输数据的能力。因此网络带宽表示在单位时间内网络中的某信道所能通过的最高数据率。

### 吞吐量

表示在单位时间内通过某个网络的实际的数据量

### 时延

是指数据从网络的一端到另一端所需要的时间。它有时也称为延迟或者迟延

(1) 发送时延 : 主机或路由器发送数据帧所需要的时间，也就是从发送数据帧的第一个比特算起，到该帧的最后一个比特发送完毕所需的时间，计算公式为

<div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-6.png' width=400>
</div>

(2) 传播时延 : 电磁波在信道中传播一定的距离需要花费的时间，计算公式为

<div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-7.png' width=400>
</div>

(3) 处理时延 : 主机或者路由器收到分组后，要花费一定的时间进行处理，这就是处理时延

(4) 排队时延 : 分组在经过网络传输时，要经过路由器。但是分组在进入路由器后要现在输入队列中排队等待处理。在路由器确定了转发接口之后，还要在输出队列中排队等待转发。排队时延的长短取决于网络当时的通信量。当网络的通信量很大时会发生队列溢出，使分组丢失，这相当于排队时延为无穷大

**总时延 = 发送时延 + 传播时延 + 处理时延 + 排队时延**

<img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-8.png' width=600>

### 往返时间 RTT

## 计算机网络体系结构

<img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-9.png' width=560>

### 五层协议

#### 应用层

通过应用进程间的交互来完成特定网络应用。比如 DNS、HTTP 协议、SMTP 协议。数据单位为报文。

#### 运输层

为进程提供通用数据传输服务。由于应用层协议很多，定义通用的传输层协议就可以支持不断增多的应用层协议。

运输层包括两种协议：`传输控制协议 TCP`，提供面向连接、可靠的数据传输服务，数据单位为报文段；`用户数据报协议 UDP`，提供无连接、尽最大努力的数据传输服务，数据单位为用户数据报。TCP 主要提供完整性服务，UDP 主要提供及时性服务。

#### 网络层

为分组交换网上的`不同主机`提供数据传输服务。在发送数据时，网络层把运输层产生的报文段或用户数据报封装成`分组`或`包`进行传送。在 TCP/IP 协议中，由于网络层使用 IP 协议，因此分组也叫做 `IP数据包`。网络层的另一任务就是 : 选择合适的路由，使源主机运输层传下来的分组，能够通过网络中的路由器找到目的主机。

常见的协议比如 CMP 、 IP 、 ARP 等协议

#### 数据链路层

网络层针对的还是主机之间的数据传输服务，而主机之间可以有很多链路，_链路层协议就是为同一链路的主机提供数据传输服务_。数据链路层把网络层传下来的`IP数据包`封装成`帧`，在两个相邻结点间的链路上传送帧。每一帧包括数据和必要的控制信息。硬件地址寻址、差错校验、将比特组合成字节进而组合成帧，用 MAC 地址访问介质

#### 物理层

考虑的是怎样在传输媒体上传输数据比特流，而不是指具体的传输媒体。物理层的作用是尽可能屏蔽传输媒体和通信手段的差异，使数据链路层感觉不到这些差异。以二进制形式传输数据

### OSI 七层协议

其中表示层和会话层用途如下：

- 表示层 ：数据压缩、加密以及数据描述，这使得应用程序不必关心在各台主机中数据内部格式不同的问题。比如 HTTP、HTTPS 等协议

- 会话层 ：建立及管理会话。比如 session、cookie

五层协议没有表示层和会话层，而是将这些功能留给应用程序开发者处理

### 数据在各层之间的传递过程

在向下的过程中，需要添加下层协议所需要的首部或者尾部，而在向上的过程中不断拆开首部和尾部。

路由器只有下面三层协议，因为路由器位于网络核心中，不需要为进程或者应用程序提供服务，因此也就不需要传输层和应用层。

<img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-10.png' width=480>

### TCP/IP 的体系结构

它只有四层，相当于五层协议中数据链路层和物理层合并为网络接口层。

<img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-11.png' width=480>

TCP/IP 体系结构不严格遵循 OSI 分层概念，应用层可能会直接使用 IP 层或者网络接口层。

<img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-12.png' width=480>

还有一种方法，就是分层次画出具体的协议来表示 TCP/IP 协议族，它的特点是 : 一种沙漏形状，中间小两边大，IP 协议在其中占据举足轻重的地位。

<img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-13.png' width=480>

---

# 二、物理层

## 物理层任务

物理层的作用及任务就是 : 尽可能地屏蔽掉传输媒体和通信手段的差异，使物理层上面的数据链路层感觉不到这种差异，这样就能使得数据链路层只需要考虑如何完成本层的协议和服务，不需要考虑网路具体的传输媒体和通信手段。

## 通信方式

首先，我们先理解一些常用术语，通信的目的是传送信息，数据是运送信息的实体，在 RFC 4949 中给出的定义，数据是使用特定方式表示的信息，通常是有意义的符号序列。信号则是数据的电气或电磁的表现。

信号分为两大类

- 模拟信号——代表信息的参数的取值是连续的。

- 数字信号——代表信息的参数的取值是离散的。

从通信的双方信息交互的方式来看，有三种基本方式:

- 单向通信 : 又称为`单工通信`，只有一个方向的通信而没有反方向的交互，比如无线电广播或有线电广播

- 双向交替通信 : 又称为`半双工通信`，通信的双方都可以发送信息，但是不能双方同时发送，当然也不能同时接收

- 双向同时通信 : 又称为`全双工通信`，通信的双方可以同时发送和接收信息

来自信源的信号常称为 `基带信号`，基带信号往往包含有较多的低频成分，甚至有直流成分，而很多信道不能传输这种低频或者直流，所以我们要进行<strong>调制</strong>

基带信号调制分两大类， **基带调制** 和 **带通调制**

### 基带调制

仅仅对基带信号的波形进行变换，使它能够与信道特性相适应。转变后的信号仍是基带信号，这种基带调制一般是把`数字信号`转换成另一种数字信号，所以这个过程常常被称为`编码`。（数字信号 - 数字信号）

<div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-14.png' width=400>
</div>

### 带通调制

使用`载波`进行调制，把基带信号的频率范围搬移到较高的频段，并转换为`模拟信号`。（数字信号 - 模拟信号）

最基本的带通调制方法有 : 调幅、调频和调相，复杂点的就正交振幅调制

<div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-15.png' width=400>
</div>

## 信道复用技术

### 1.频分复用

频分复用的所有用户在相同的时间占用不同的频率带宽资源。

<div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-16.png' width=400>
</div>

### 2.时分复用

时分复用的所有用户在不同的时间占用相同的频率带宽资源。

<div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-17.png' width=400>
</div>

使用频分复用和时分复用进行通信，在通信的过程中主机会一直占用一部分信道资源。但是由于计算机数据的突发性质，通信过程没必要一直占用信道资源而不让出给其它用户使用，因此这两种方式对信道的利用率都不高。

### 3.统计时分复用

是对时分复用的一种改进，不固定每个用户在时分复用帧中的位置，只要有数据就集中起来组成统计时分复用帧然后发送。

<div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-18.png' width=400>
</div>

### 4.波分复用

光的频分复用。由于光的频率很高，因此习惯上用波长而不是频率来表示所使用的光载波。

<div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-19.png' width=660>
</div>

### 5.码分复用

又称为 : `码分多址CDMA`。在 CDMA 中，每一个比特时间再划分为 m 个短的间隔，称为`码片`，通常 m 的值是 64 或 128。

使用 CDMA 的每一个站被指派一个唯一的 m bit 码片序列，一个站如果要发送比特 1，那么就发送自己的 m bit 码片序列。如果要发送比特 0，就发送该码片序列的二进制反码。例如，指派给 S 站的 8 bit 码片序列是 00011011，那么当 S 发送比特 1 时，它就发送序列 00011011，如果 S 发送比特 0 时，就发送 11100100

<div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-20.png' width=660>
</div>

---

# 三、数据链路层

## 信道分类

我们先明确一个概念，“链路” 和 “数据链路” 并不是一回事。链路是从一个结点到相邻结点的一段物理线路。数据链路是除了必须有一条物理线路外，还必须有一些必要的通信协议来控制这些数据的传输。常用的方法是使用`网络适配器`来实现这些协议。

### 1. 点对点信道

一对一通信。

因为不会发生碰撞，因此也比较简单，使用[PPP 协议](#PPP协议)进行控制。

### 2. 广播信道

一对多通信，一个节点发送的数据能够被广播信道上所有的节点接收到。

所有的节点都在同一个广播信道上发送数据，因此需要有专门的控制方法进行协调，避免发生冲突（冲突也叫碰撞）。

主要有两种控制方法进行协调，一个是使用[信道复用技术](#信道复用技术)，一是使用 [CSMA/CD 协议](#CSMA/CD协议)。

## 三个基本问题

数据链路层协议有很多种，但是有三个基本问题是共同的 : 封装成帧、透明传输、差错检测

### 封装成帧

`封装成帧`就是在一段数据的前后分别添加首部和尾部，接收端在收到物理层上交的比特流后，就能根据首部和尾部的标记，从收到的比特流中识别帧的开始和结束。

一个帧的长度等于帧的数据部分长度加上帧首部和帧尾部的长度。首部和尾部的一个重要作用是进行帧定界。每一种链路层协议都规定了所能传送的帧的数据部分长度上线——最大传送单元 MTU(默认值 1500 字节)

<div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-21.png' width=600>
</div>

如果数据是又可打印的 ASCII 码组成的文本文件时，帧定界可以使用特殊的`帧定界符`，SOH 放在一帧的最前面，表示帧的首部开始。EOT 表示帧的结束。他们都是十六进制，编码分别是 01(二进制 00000001)和 04(二进制 00000100)

在数据传输中出现差错时，帧定界符作用更加明显。比如发送端在发送一个帧时突然出故障，中断了发送。但是很快又恢复正常，于是从头开始发送刚才未发送完的帧。于是使用了`帧定界符`，接收端就能知道前面收到的数据是个不完整的帧。

### 透明传输

帧的开始和结束都是通过使用专门指明的控制字符，如 SOH 和 EOT 等。当传送的是用文本文件组成的帧时，不管从键盘输入什么字符都可以放在这样的帧中传输过去，因此这样的传输是`透明传输`

但是！！！如果数据部分是非 ACSII 码的文本文件时（二进制的图像)，如果数据中的某个字节的二进制码刚好是 SOH 或 EOT 这种控制字符一样，那么，数据链路层就会错误地认为“找到帧的边界”，误认为是一个“完整的帧”，而把剩下的部分数据丢弃。

<div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-22.png' width=600>
</div>

透明 ： 它表示某个实际存在的  事物看起来却好像不存在一样。

为了解决透明传输问题，使用一种方法叫做`字节填充`或称为`字符填充`。具体方法是 : 发送端的数据链路层在数据中出现控制字符“SOH”或“EOT”的前面插入一个`转义字符“ESC”`。而在接收端的数据链路层接收到数据后，在送往网络层之前删除这个插入的转义字符。

<div align='left'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-23.png' width=600>
</div>

### 差错检测

比特在传输过程中可能会出现差错 : 1 可能变为了 0， 而 0 可能变成了 1，这就叫做`比特差错`。

为了保证数据传输的可靠性，在计算机网络传输数据时，必须采用各种差错检测措施。目前在数据链路层广泛使用了`循环冗余检验CRC`的检错技术。

CRC 运算就是在数据 M 的后面添加供差错检测用的 n 位冗余码，这种为了进行检错而添加的冗余码常被称为`帧检验序列FCS`

> CRC 是一种检错方法，FCS 是添加在数据后面的冗余码

## PPP 协议

互联网用户通常需要连接到某个 ISP 之后才能接入到互联网，PPP 协议是用户计算机和 ISP 进行通信时所使用的数据链路层协议。

<div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-24.png' width=600>
</div>

### PPP 协议组成

- 一个将 IP 数据报封装成串行链路的方法

- 一个用来建立、配置和测试数据链路连接的链路控制协议 LCP

- 一套网络控制协议 NCP

### PPP 协议的帧格式

<div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-25.png' width=660>
</div>

各字段意义

- F 字段为帧的定界符，规定为 0x7E（二进制 01111110）， '0x'表示它后面的字符是用十六进制表示的。如果连续出现两个标志字段，就表示这是一个空帧，应当丢弃

- A 和 C 字段暂时没有意义

- FCS 字段是使用 CRC 的检验序列

- 信息部分长度可变，但长度不超过 1500

### 零比特填充

PPP 协议在使用 SONET/SDH 链路时，使用同步传输，在这种情况下，使用`零比特填充`方法来实现透明传输。

具体做法是 : 在发送端，扫描整个信息字段，只要发现有 5 个连续的 1，就立即填入一个 0。就可以保证信息字段中不会出现 6 个 1；在接收端收到一个帧时，先找到标志字段 F 来确定一个帧的边界，然后扫描信息部分，每当发现 5 个连续 1 时，就把 5 个 1 后面的 0 删除，还原成原来的信息比特流。这就保证了透明传输

<div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-26.png' width=600>
</div>

### PPP 协议的工作状态

<div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-27.png' width=600>
</div>

PPP 链路的起始和终止状态永远都是 `链路静止` 状态，这时在用户个人电脑和 ISP 的路由器之间并不存在物理层的链接

当用户个人电脑通过`调制解调器`呼叫路由器时 (通常是屏幕上用鼠标点击一个连接按钮)，`路由器`就能检测到`调制解调器`发出的载波信号。在双方建立了物理层连接后，PPP 就进入了 `链路建立` 状态，其目的是建立链路层的 LCP 连接

这时链路控制协议 LCP 开始协商一些配置选项，即发送`LCP配置请求帧`。协商结束后双方建立了 LCP 链路，进入到 `鉴别` 状态。在这一状态，**只允许传送 LCCP 协议的分组、鉴别协议的分组和检测链路质量的分组**。如果使用`PAP密码认证协议`，则需要发起通信的一方发送身份标识和口令。如果需要更好的安全性，则可使用更加复杂的`CHAP询问握手认证协议(三次握手)`。鉴别失败，进入 `链路终止` 状态，如果鉴别成功，进入 `网路层协议` 状态。

在 “网络层协议” 状态，PPP 链路两端的网络控制协议 NCP 根据网络层的不同协议相互交换网络层特定的网络控制分组。

当网络层配完毕后，链路进入可进行数据通信的 `链路打开` 状态。链路的两个 PPP 端点可以批次向对方发送分组

数据传输结束后，链路的一端发出`终止请求LCP分组`请求终止链路连接，在收到对方发来的`终止确认LCP分组`后，转到 `链路终止` 状态。如果链路出现故障，也会从 “链路打开” 状态转到 “链路终止” 状态。

当调制解调器的载波停止时，回到 `链路静止` 状态

## 局域网

局域网的主要特点是 : 网络为一个单位所拥有，且地理范围和站点数目均有限

可以按照网络拓扑结构对局域网进行分类：

<div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-28.png' width=600>
</div>

## 适配器

计算机与外界局域网的连接是通过`通信适配器`进行的。适配器本身是在主机箱内插入的一块网络接口板。这种接口板又称为`网络接口卡NIC`，简称为 `网卡`。

在这种通信适配器上面装有处理器和存储器（包括 RAM 和 ROM）。适配器和局域网之间的通信是通过电缆或双绞线以`串行传输方式`进行的。而适配器和计算机之间的通信则是通过计算机主板上的 I/O 总线以`并行传输方式`进行的。

适配器的一个重要功能就是 : 进行数据串行传输和并行传输的转换。

适配器在接受和发送各种帧时，不使用计算机的 CPU。当适配器收到有差错的帧时，直接丢弃这个帧而不需要通知计算机。如果收到正确的帧，就会通过中断来通知计算机，并交付协议栈中的网络层。当计算机要发送 IP 数据报时，就由协议栈把 IP 数据报向下交给适配器，组装成帧发送给局域网。

计算机的硬件地址(MAC 地址)就在适配器的 ROM 中，而计算机的软件地址(IP 地址)，在计算机的存储器中

## CSMA/CD 协议

CSMA/CD 表示 ：载波监听多点介入/碰撞检测

- 多点接入 : 说明这是总线型网络，许多主机以多点的方式连接到总线上。

- 载波监听 : 就是检测信道，不管在发送前，还是发送中，每个站都必须不停地检测信道。如果监听到信道正在使用，就必须等待。

- 碰撞检测 : 边发送边监听，在发送中，如果监听到信道已有其它主机正在发送数据，就表示发生了碰撞。

为什么每一个站在发送数据前都已经监听到信道为 "空闲"，那么为什么还会出现数据在总线上的碰撞呢 ？

> 虽然每个主机在发送数据之前都已经监听到信道为空闲，但是由于电磁波的`传播时延`的存在，还是有可能会发生碰撞。

在使用 CSMA/CD 协议时，一个站<strong>不可能同时进行发送和接收，但必须边发送边监听信道</strong>。因此使用 CSMA/CD 协议的以太网只能进行`双向交替通信(半双工通信)`

记端到端的传播时延为 τ，最先发送的站点最多经过 2τ 就可以知道是否发生了碰撞，称 2τ 为 <strong>争用期</strong> 。只有经过争用期之后还没有检测到碰撞，才能肯定这次发送不会发生碰撞。

当发生碰撞时，站点要停止发送，等待一段时间再发送。这个时间采用 **截断二进制指数退避算法** 来确定。从离散的整数集合 [0, 1, .., (2<sup>k</sup>-1)] 中随机取出一个数，记作 r，然后取 r 倍的争用期作为重传等待时间。

<div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-29.png' width=600>
</div>

注意 : 适配器没发送一个新的帧，就要执行一次 CSMA/CD 算法，适配器对过去发生的碰撞并无记忆功能。因此，当好几个适配器正在执行指数退避算法时，很可能有一个新的适配器发送的新帧能够碰巧立即成功地插入到信道中，得到了发送权，而已经推迟好几次发送的站，有可能很不巧，还要继续执行退避算法，继续等待。

以太网规定了一个最短帧长 64 字节，即 512bit，如果要发送的数据非常少，那么必须加入一些填充字节，使得帧长不少于 64 字节。因此可见，以太网在发送数据时，如果在争用期(共发送了 64 字节)没有发生碰撞，那么后续发送的数据就一定不会发生冲突。也就是说，如果发生碰撞，就一定是在发送前的 64 字节以内。<strong>但凡长度小于 64 字节的帧都是由于冲突而异常终止的无效帧。</strong>以太网规定`帧间最小间隔`为 9.6us，相当于 96 比特时间。这样的目的是使得刚刚接收到数据帧的站的接受缓存来得及清理，做好接收下一个帧的准备。

### CSMA/CCD 协议的要点归纳

#### (1). 准备发送

适配器从网络层获得一个分组，加上以太网的首部和尾部，组成以太网帧，放入到适配器的缓存中，但是在发送前，要检测信道

#### (2). 检测信道

如果检测到信道忙，那么应不断检测，一直等到信道空闲。如果检测到信道空闲，并在规定的 96 比特时间内保持空闲，就发送这个帧

#### (3). 发送过程不断检测信道

即网络适配器要边发送边监听，这里只有两种可能 :

- 发送成功 : 在争用期内一直未检测到碰撞，这个帧肯定能够发送成功。发送完毕之后，回到 (1)

- 发生失败 : 在争用期内检测到碰撞，立即停止发送数据，适配器执行断指二进制指数退避算法，等待 r 倍 512 比特时间后，返回 (2)，继续检测信道，如果重  传 16 次不成功，那么停止重传，并向上层报错。

## 以太网的 MAC 层

在局域网中，硬件地址又称为物理地址或 MAC 地址。当路由器通过适配器连接到局域网时，适配器上的硬件地址就用来标志路由器的某个接口。路由器如果同时连接到两个网络上，那么它就需要两个适配器和两个硬件地址。以太网适配器可以设置一种特殊的工作方式——混杂方式。工作在混杂方式的适配器只要“听到”有帧在以太网上传输，就会悄悄地接受下来。不管这些帧发送到哪个站。

> 我们在互联网上，进行主机间的通信时，通过分组交换传输报文，在报文中会标有源地址和目的地址，通过路由器来转发分组，而路由器通过适配器连接到局域网。计算机与外界局域网的连接是通过通信适配器进行的，因为适配器的一种特殊工作方式，所以黑客可以利用这种方式，非法获取用户的口令，甚至截取用户发送的数据包。

### MAC 帧的格式

<div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-30.png' width=600>
</div>

五个字段 :

- 6 字节长的目的地址字段

- 6 字节长的源地址字段

- 2 字节长的类型字段 : 表示上层使用的是什么协议，如果字段值 0x0800，那么就是 IP 数据报。如果值是 0x8137，那么就是 Novell IPX 发送过来的

- 长度在 46~1500 字节之间的数据字段 : 46 字节是最小长度 64 字节-18 字节的首尾部得出的最小长度。

- 4 字节的帧检验序列 FCS 字段

当数据字段的长度小于 46 字节，就会在数据字段中添加一个整数字节的填充字段，以保证 MAC 帧不下小于 64 字节。

现在有个问题 : 接收端的 MAC 子层在剥去首尾部后就把数据字段和填充字段交付给上层协议，那么上层协议如何知道填充字节的长度呢？

> 当上层使用的是 IP 协议时，其首部就有一个“总长度”字段，因此，总长度加上填充字段的长度，应当等于 MAC 帧数据字段的长度。例如，IP 数据报的总长度为 42 个字节，填充字段共 4 字节。当 MAC 帧把 46 字节的数据交给 IP 层后，IP 层就会把其中最后 4 个字节的填充字段丢弃

从上图可以看到，实际传送的要比 MAC 帧还多 8 个字节，这是因为一个站在刚开始接收 MAC 帧时，由于适配器的时钟尚未与到达的比特流达到同步，因此 MAC 帧的最前面若干位就无法接收，结果使整个 MAC 成为无用的帧。

为了快速实现同步，MAC 子层向下传到物理层时还要在帧前插入 8 字节，它由两个字段构成 : 第一个字段是 7 个字节的`前同步码(1和0交替码)`，作用是使得接收端的适配器在接收 MAC 帧的时候快速调整其时钟频率，使它与发送端的时钟同步。第二个字段是`帧开始定界符`，定义为 10101011，最后的两个连续的 1 是告诉接收端适配器 : “MAC 帧的信息马上来了，请适配器注意接收”。是为了计算 FCS 临时加入的，计算完后就会丢弃

> 以太网传输数据是以帧为单位传送的。在以太网传送帧时，各帧之间还必须有一定的间隙。

## 扩展的以太网

### 在物理层扩展以太网

常使用工作在物理层的`转发器`来扩展以太网的地理覆盖范围。

现在扩展主机和集线器之间的距离的一种简单方法就是使用`光纤`和一对`光纤调制解调器`。

### 在数据链路层扩展以太网

最初使用的是`网桥`，现在使用`交换机`

以太网交换机实质上就是一个多接口的网桥，并且是一种即插即用设备，其内部的帧交换表(又称为地址表)是通过`自学习`算法自动的逐渐建立起来的。

下边是自学习的过程 :

<div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-31.png' width=600>
</div>

A 先 B 发送一个帧，从接口 1 进入到交换机，交换机接收到帧后，查找交换表，发现没有哪个接口可以转发这个帧。接着，交换机把这个帧的源地址 A 和接口 1 写入交换表中，并向除接口 1 以外的所有接口广播这个帧。

C、D 将会丢弃这个帧，因为目的地址不正确。而 B 会收下这个目的地址正确的帧，这也叫做过滤

接下来 B 通过接口 3 向 A 发送一帧，交换机查找交换表，发现交换表中的 MAC 地址有 A，从接口 1 转发出去，于是把这个帧传送到接口 1 转发给 A。然后交换表中新增 (B, 3)，表示以后如果有要发送给 B 的帧，就从接口 3 转发出去

## 虚拟局域网

虚拟局域网可以建立与物理位置无关的逻辑组，只有在同一个虚拟局域网中的成员才会收到链路层广播信息。

例如下图中 (A1, A2, A3, A4) 属于一个虚拟局域网，A1 发送的广播会被 A2、A3、A4 收到，而其它站点收不到。

使用 VLAN 干线连接来建立虚拟局域网，每台交换机上的一个特殊接口被设置为干线接口，以互连 VLAN 交换机。IEEE 定义了一种扩展的以太网帧格式 802.1Q，它在标准以太网帧上加进了 4 字节首部 VLAN 标签，用于表示该帧属于哪一个虚拟局域网。

<div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-32.png' width=600>
</div>

---

# 四、网络层

## 概述

因为网络层是整个互联网的核心，因此应当让网络层尽可能简单。**网络层向上只提供简单灵活的、无连接的、尽最大努力交互的数据报服务。**

## 网际协议 IP

与 IP 协议配套使用的还有三个协议：

- 地址解析协议 ARP（Address Resolution Protocol）

- 网际控制报文协议 ICMP（Internet Control Message Protocol）

- 网际组管理协议 IGMP（Internet Group Management Protocol

还有一个逆地址解析协议 RARP ，但已被淘汰不使用了。下图画出了这三个协议与网际协议 IP 的关系。在这一层中，ARP 在最下面，因为 IP 经常要用到这个协议。ICMP 和 IGMP 在着一层的上面，因为它们要使用 IP 协议。

<!-- <div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-33.png' width=500>
</div> -->

将网络互相连接起来是要使用一些中间设备。根据中间设备所在的层次，可以有以下四种不同的中间设备:

- 物理层使用的中间设备叫做 : `转发器`

- 数据链路层使用的中间设备叫做 : `网桥`

- 网络层使用的中间设备叫做 : `路由器`

- 在网络层以上使用的中间设备叫做 : `网关`

使用 IP 协议，可以把异构的物理网络连接起来，使得在网络层看起来好像是一个统一的网络。

<div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-34.png' width=700>
</div>

## 分类的 IP 地址

IP 地址就是给互联网上的每一台主机(或路由器)的每一个接口分配一个在全世界范围内是唯一的 32 位的标识符

IP 地址的编地方式经历了三个历史阶段：

- 子类的 IP 地址
- 子网的划分
- 构成超网

> 所谓的 IP 地址，就是将 IP 地址划分为若干个固定类，每一类地址都由两个固定长度的字段组成， 第一个字段 `网络号`, 第二个字段 `主机号`, 不同分类具有不同的网络号长度，并且是固定的。

IP 地址 ::= {< 网络号 >, < 主机号 >}

<div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-35.png' width=700>
</div>

采用 `点分十进制记法` 提高可读性

<div align='center'>
  <img src='https://github.com/PDKSophia/read-booklist/raw/master/book-image/network/net-36.png' width=700>
</div>

---

# 参考资料

CS-Notes : https://github.com/CyC2018/CS-Notes/blob/master/notes/计算机网络.md
